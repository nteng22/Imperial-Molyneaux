meta_table <- data %>%
select(index:patient_ID)
meta_table$`Sample-type` <- as.factor(meta_table$`Sample-type`)
meta_table$Status <- as.factor(meta_table$Status)
meta_table$patient_ID <- as.factor(meta_table$patient_ID)
## Phyla analysis ##
top <- abund_table[,order(colSums(abund_table),decreasing=TRUE)]
N <- 10
taxa_list <- colnames(top)[1:N]
N <- length(taxa_list)
top <- data.frame(top[,colnames(top) %in% taxa_list])
top
other <- abund_table[,order(colSums(abund_table),decreasing=TRUE)]
N <- dim(abund_table)[2] # This needs to be the total number of colums in the dataframe.
taxa_list2 <- colnames(other)[11:N]
N <- length(taxa_list2)
Others <- data.frame(other[,colnames(other) %in% taxa_list2])
Others
Others <- rowSums(Others)
Others <- as.data.frame(Others)
Others
top_other <- cbind(top, Others)
top_other
top_other_rowsums <- rowSums(top_other)
top_other_rowsums <- as.data.frame(top_other_rowsums)
top_other_rowsums
sample_data <- cbind(meta_table, top_other)
sample_data_long <- melt(sample_data, id.vars = c("index",
"Sample-type",
"Status",
"patient_ID"), variable.name = "Phylum")
sample_data_long
sample_data_long_summarised <- sample_data_long %>%
group_by(`Sample-type`, Status, patient_ID, Phylum) %>%
summarize(value=mean(value))
taxa_list
Palette <- c(Firmicutes = "darkseagreen1",
Bacteroidetes = "darkslategray2",
Proteobacteria = "hotpink3",
Actinobacteria = "goldenrod1",
Fusobacteria = "palegreen3",
Spirochaetes = "plum",
Synergistetes = "tan2",
SR1 = "darkseagreen4",
TM7 = "darkslategray4",
Tenericutes = "deeppink3",
Others = "grey")
plot <- ggplot(data = sample_data_long_summarised,
aes(x = `Sample-type`,
stratum = value,
alluvium = Phylum,
y = value,
fill = Phylum,
label = Phylum)) +
geom_alluvium(aes(fill = Phylum), decreasing = FALSE) +
geom_flow(decreasing = FALSE) +
geom_stratum(alpha = 0.5, decreasing = FALSE) +
geom_text(stat = "alluvium",
aes(label = Phylum), size= 1.75,
decreasing = FALSE) +
facet_wrap(patient_ID ~ . ) +
scale_fill_manual(values = Palette) +
theme_classic()
plot <- plot + labs(x = "Time point", y = "Relative abundance (%)",
title = "Relative abundance of Phyla") +
theme(legend.text = element_text(size=8,
face = "italic"))
plot
ggsave("Paired-samples alluvial Phylum.pdf", width = 500, height=500, units = c("mm"), dpi=400)
plot <- plot + labs(x = "Sample type", y = "Relative abundance (%)",
title = "Relative abundance of Phyla") +
theme(legend.text = element_text(size=8,
face = "italic"))
plot
plot
ggsave("Paired-samples alluvial Phylum.pdf", width = 800, height=500, units = c("mm"), dpi=400)
setwd("~/GitHub/Imperial-Molyneaux/COVID-BAL-OralRinse/Unfiltered/Class/")
library(dplyr)
library(tidyverse)
library(reshape2)
library(vegan)
library(ggalluvial)
path <- "~/GitHub/Imperial-Molyneaux/COVID-BAL-OralRinse/Unfiltered/Class/"
list.files(path)
data <- read_csv("Class-normalised-unfiltered-metadata.csv") %>%
filter(!Status == "control") %>% #Only select for samples that are paired
group_by(patient_ID) %>%
filter(n()==2) %>%
filter(!patient_ID == "1069") # Manually remove, has two copies of OR?
abund_table <- data %>%
select(index,5:ncol(data))
abund_table <- column_to_rownames(abund_table, var = "index")
abund_table <- abund_table %>%
select(where(is.numeric)) %>%
select(where(~sum(.) > 0))
rowSums(abund_table)
abund_table <- abund_table/rowSums(abund_table)*100 # Relative abundances %
meta_table <- data %>%
select(index:patient_ID)
meta_table$`Sample-type` <- as.factor(meta_table$`Sample-type`)
meta_table$Status <- as.factor(meta_table$Status)
meta_table$patient_ID <- as.factor(meta_table$patient_ID)
## Phyla analysis ##
top <- abund_table[,order(colSums(abund_table),decreasing=TRUE)]
## Class analysis ##
top <- abund_table[,order(colSums(abund_table),decreasing=TRUE)]
N <- 10
taxa_list <- colnames(top)[1:N]
N <- length(taxa_list)
top <- data.frame(top[,colnames(top) %in% taxa_list])
top
other <- abund_table[,order(colSums(abund_table),decreasing=TRUE)]
N <- dim(abund_table)[2] # This needs to be the total number of colums in the dataframe.
taxa_list2 <- colnames(other)[11:N]
N <- length(taxa_list2)
Others <- data.frame(other[,colnames(other) %in% taxa_list2])
Others
Others <- rowSums(Others)
Others <- as.data.frame(Others)
Others
top_other <- cbind(top, Others)
top_other
top_other_rowsums <- rowSums(top_other)
top_other_rowsums <- as.data.frame(top_other_rowsums)
top_other_rowsums
sample_data <- cbind(meta_table, top_other)
sample_data_long <- melt(sample_data, id.vars = c("index",
"Sample-type",
"Status",
"patient_ID"), variable.name = "Class")
sample_data_long
sample_data_long_summarised <- sample_data_long %>%
group_by(`Sample-type`, Status, patient_ID, Class) %>%
summarize(value=mean(value))
taxa_list
Palette <- c(Clostridia = "darkseagreen1",
Bacteroidia = "darkslategray2",
Bacilli = "hotpink3",
Fusobacteriia = "goldenrod1",
Actinobacteria = "palegreen3",
Gammaproteobacteria = "plum",
Flavobacteriia = "tan2",
Betaproteobacteria = "darkseagreen4",
Spirochaetes = "darkslategray4",
Erysipelotrichi = "deeppink3",
Others = "grey")
plot <- ggplot(data = sample_data_long_summarised,
aes(x = `Sample-type`,
stratum = value,
alluvium = Class,
y = value,
fill = Class,
label = Class)) +
geom_alluvium(aes(fill = Class), decreasing = FALSE) +
geom_flow(decreasing = FALSE) +
geom_stratum(alpha = 0.5, decreasing = FALSE) +
geom_text(stat = "alluvium",
aes(label = Class), size= 1.75,
decreasing = FALSE) +
facet_wrap(patient_ID ~ . ) +
scale_fill_manual(values = Palette) +
theme_classic()
plot <- plot + labs(x = "Sample type", y = "Relative abundance (%)",
title = "Relative abundance of Phyla") +
theme(legend.text = element_text(size=8,
face = "italic"))
plot
plot <- plot + labs(x = "Sample type", y = "Relative abundance (%)",
title = "Relative abundance of Classes") +
theme(legend.text = element_text(size=8,
face = "italic"))
plot
ggsave("Paired-samples alluvial Class.pdf", width = 800, height=500, units = c("mm"), dpi=400)
setwd("~/GitHub/Imperial-Molyneaux/COVID-BAL-OralRinse/Filtered data//")
path <- "~/GitHub/Imperial-Molyneaux/COVID-BAL-OralRinse/"
list.files(path)
data <- read_csv("../Phylum-normalised-metadata.csv") %>%
filter(!Status == "control") %>% #Only select for samples that are paired
group_by(patient_ID) %>%
filter(n()==2) %>%
filter(!patient_ID == "1069") # Manually remove, has two copies of OR?
abund_table <- data %>%
select(index,5:ncol(data))
abund_table <- column_to_rownames(abund_table, var = "index")
abund_table <- abund_table %>%
select(where(is.numeric)) %>%
select(where(~sum(.) > 0))
rowSums(abund_table)
abund_table <- abund_table/rowSums(abund_table)*100 # Relative abundances %
meta_table <- data %>%
select(index:patient_ID)
meta_table$`Sample-type` <- as.factor(meta_table$`Sample-type`)
meta_table$Status <- as.factor(meta_table$Status)
meta_table$patient_ID <- as.factor(meta_table$patient_ID)
## Phyla analysis ##
top <- abund_table[,order(colSums(abund_table),decreasing=TRUE)]
N <- 10
taxa_list <- colnames(top)[1:N]
N <- length(taxa_list)
top <- data.frame(top[,colnames(top) %in% taxa_list])
top
other <- abund_table[,order(colSums(abund_table),decreasing=TRUE)]
N <- dim(abund_table)[2] # This needs to be the total number of colums in the dataframe.
taxa_list2 <- colnames(other)[11:N]
N <- length(taxa_list2)
Others <- data.frame(other[,colnames(other) %in% taxa_list2])
Others
Others <- rowSums(Others)
Others <- as.data.frame(Others)
Others
top_other <- cbind(top, Others)
top_other
top_other_rowsums <- rowSums(top_other)
top_other_rowsums <- as.data.frame(top_other_rowsums)
top_other_rowsums
sample_data <- cbind(meta_table, top_other)
sample_data_long <- melt(sample_data, id.vars = c("index",
"Sample-type",
"Status",
"patient_ID"), variable.name = "Phylum")
sample_data_long
sample_data_long_summarised <- sample_data_long %>%
group_by(`Sample-type`, Status, patient_ID, Phylum) %>%
summarize(value=mean(value))
taxa_list
Palette <- c(Firmicutes = "darkseagreen1",
Bacteroidetes = "darkslategray2",
Proteobacteria = "hotpink3",
Actinobacteria = "goldenrod1",
Fusobacteria = "palegreen3",
Spirochaetes = "plum",
Synergistetes = "tan2",
SR1 = "darkseagreen4",
Thermi.X. = "darkslategray4",
TM7 = "deeppink3",
Others = "grey")
plot <- ggplot(data = sample_data_long_summarised,
aes(x = `Sample-type`,
stratum = value,
alluvium = Phylum,
y = value,
fill = Phylum,
label = Phylum)) +
geom_alluvium(aes(fill = Phylum), decreasing = FALSE) +
geom_flow(decreasing = FALSE) +
geom_stratum(alpha = 0.5, decreasing = FALSE) +
geom_text(stat = "alluvium",
aes(label = Phylum), size= 1.75,
decreasing = FALSE) +
facet_wrap(patient_ID ~ . ) +
scale_fill_manual(values = Palette) +
theme_classic()
plot <- plot + labs(x = "Sample type", y = "Relative abundance (%)",
title = "Relative abundance of Phyla") +
theme(legend.text = element_text(size=8,
face = "italic"))
plot
plot <- plot + labs(x = "Sample type", y = "Relative abundance (%)",
title = "Relative abundance of Phyla",
subtitle = "filtered data based off of prevalence") +
theme(legend.text = element_text(size=8,
face = "italic"))
plot
ggsave("Paired-samples alluvial Phylum filtered.pdf", width = 800, height=500, units = c("mm"), dpi=400)
setwd("~/GitHub/Imperial-Molyneaux/COVID-BAL-OralRinse/Unfiltered/Family/")
library(dplyr)
library(tidyverse)
library(reshape2)
library(vegan)
library(ggalluvial)
path <- "~/GitHub/Imperial-Molyneaux/COVID-BAL-OralRinse/Unfiltered/Family/"
list.files(path)
data <- read_csv("Family-normalised-unfiltered-metadata.csv") %>%
filter(!Status == "control") %>% #Only select for samples that are paired
group_by(patient_ID) %>%
filter(n()==2) %>%
filter(!patient_ID == "1069") # Manually remove, has two copies of OR?
abund_table <- data %>%
select(index,5:ncol(data))
abund_table <- column_to_rownames(abund_table, var = "index")
abund_table <- abund_table %>%
select(where(is.numeric)) %>%
select(where(~sum(.) > 0))
rowSums(abund_table)
abund_table <- abund_table/rowSums(abund_table)*100 # Relative abundances %
meta_table <- data %>%
select(index:patient_ID)
meta_table$`Sample-type` <- as.factor(meta_table$`Sample-type`)
meta_table$Status <- as.factor(meta_table$Status)
meta_table$patient_ID <- as.factor(meta_table$patient_ID)
## Family analysis ##
top <- abund_table[,order(colSums(abund_table),decreasing=TRUE)]
N <- 10
taxa_list <- colnames(top)[1:N]
N <- length(taxa_list)
top <- data.frame(top[,colnames(top) %in% taxa_list])
top
other <- abund_table[,order(colSums(abund_table),decreasing=TRUE)]
N <- dim(abund_table)[2] # This needs to be the total number of colums in the dataframe.
taxa_list2 <- colnames(other)[11:N]
N <- length(taxa_list2)
Others <- data.frame(other[,colnames(other) %in% taxa_list2])
Others
Others <- rowSums(Others)
Others <- as.data.frame(Others)
Others
top_other <- cbind(top, Others)
top_other
top_other_rowsums <- rowSums(top_other)
top_other_rowsums <- as.data.frame(top_other_rowsums)
top_other_rowsums
sample_data <- cbind(meta_table, top_other)
sample_data_long <- melt(sample_data, id.vars = c("index",
"Sample-type",
"Status",
"patient_ID"), variable.name = "Family")
sample_data_long
sample_data_long_summarised <- sample_data_long %>%
group_by(`Sample-type`, Status, patient_ID, Family) %>%
summarize(value=mean(value))
taxa_list
Palette <- c(Firmicutes = "darkseagreen1",
Bacteroidetes = "darkslategray2",
Proteobacteria = "hotpink3",
Actinobacteria = "goldenrod1",
Fusobacteria = "palegreen3",
Spirochaetes = "plum",
Synergistetes = "tan2",
SR1 = "darkseagreen4",
TM7 = "darkslategray4",
Tenericutes = "deeppink3",
Others = "grey")
plot <- ggplot(data = sample_data_long_summarised,
aes(x = `Sample-type`,
stratum = value,
alluvium = Family,
y = value,
fill = Family,
label = Family)) +
geom_alluvium(aes(fill = Family), decreasing = FALSE) +
geom_flow(decreasing = FALSE) +
geom_stratum(alpha = 0.5, decreasing = FALSE) +
geom_text(stat = "alluvium",
aes(label = Family), size= 1.75,
decreasing = FALSE) +
facet_wrap(patient_ID ~ . ) +
scale_fill_manual(values = Palette) +
theme_classic()
plot <- plot + labs(x = "Sample type", y = "Relative abundance (%)",
title = "Relative abundance of Family") +
theme(legend.text = element_text(size=8,
face = "italic"))
plot
taxa_list
View(top)
Palette <- c(Veillonellaceae = "darkseagreen1",
Prevotellaceae = "darkslategray2",
Lachnospiraceae = "hotpink3",
X.Mogibacteriaceae. = "goldenrod1",
Leptotrichiaceae = "palegreen3",
Streptococcaceae = "plum",
Unknown = "tan2",
Actinomycetaceae = "darkseagreen4",
Micrococcaceae = "darkslategray4",
Fusobacteriaceae = "deeppink3",
Others = "grey")
plot <- ggplot(data = sample_data_long_summarised,
aes(x = `Sample-type`,
stratum = value,
alluvium = Family,
y = value,
fill = Family,
label = Family)) +
geom_alluvium(aes(fill = Family), decreasing = FALSE) +
geom_flow(decreasing = FALSE) +
geom_stratum(alpha = 0.5, decreasing = FALSE) +
geom_text(stat = "alluvium",
aes(label = Family), size= 1.75,
decreasing = FALSE) +
facet_wrap(patient_ID ~ . ) +
scale_fill_manual(values = Palette) +
theme_classic()
plot <- plot + labs(x = "Sample type", y = "Relative abundance (%)",
title = "Relative abundance of Family") +
theme(legend.text = element_text(size=8,
face = "italic"))
plot
setwd("~/GitHub/Imperial-Molyneaux/COVID-BAL-OralRinse/Filtered data//")
data <- read_csv("../Phylum-normalised-metadata.csv") %>%
filter(!Status == "control") %>% #Only select for samples that are paired
group_by(patient_ID) %>%
filter(n()==2) %>%
filter(!patient_ID == "1069") # Manually remove, has two copies of OR?
abund_table <- data %>%
select(index,5:ncol(data))
abund_table <- column_to_rownames(abund_table, var = "index")
abund_table <- abund_table %>%
select(where(is.numeric)) %>%
select(where(~sum(.) > 0))
rowSums(abund_table)
abund_table <- abund_table/rowSums(abund_table)*100 # Relative abundances %
meta_table <- data %>%
select(index:patient_ID)
meta_table$`Sample-type` <- as.factor(meta_table$`Sample-type`)
meta_table$Status <- as.factor(meta_table$Status)
meta_table$patient_ID <- as.factor(meta_table$patient_ID)
## Phyla analysis ##
top <- abund_table[,order(colSums(abund_table),decreasing=TRUE)]
N <- 10
taxa_list <- colnames(top)[1:N]
N <- length(taxa_list)
top <- data.frame(top[,colnames(top) %in% taxa_list])
top
other <- abund_table[,order(colSums(abund_table),decreasing=TRUE)]
N <- dim(abund_table)[2] # This needs to be the total number of colums in the dataframe.
taxa_list2 <- colnames(other)[11:N]
N <- length(taxa_list2)
Others <- data.frame(other[,colnames(other) %in% taxa_list2])
Others
Others <- rowSums(Others)
Others <- as.data.frame(Others)
Others
top_other <- cbind(top, Others)
top_other
top_other_rowsums <- rowSums(top_other)
top_other_rowsums <- as.data.frame(top_other_rowsums)
top_other_rowsums
sample_data <- cbind(meta_table, top_other)
sample_data_long <- melt(sample_data, id.vars = c("index",
"Sample-type",
"Status",
"patient_ID"), variable.name = "Phylum")
sample_data_long
sample_data_long_summarised <- sample_data_long %>%
group_by(`Sample-type`, Status, patient_ID, Phylum) %>%
summarize(value=mean(value))
taxa_list
Palette <- c(Firmicutes = "darkseagreen1",
Bacteroidetes = "darkslategray2",
Proteobacteria = "hotpink3",
Actinobacteria = "goldenrod1",
Fusobacteria = "palegreen3",
Spirochaetes = "plum",
Synergistetes = "tan2",
SR1 = "darkseagreen4",
X.Thermi. = "darkslategray4",
TM7 = "deeppink3",
Others = "grey")
plot <- ggplot(data = sample_data_long_summarised,
aes(x = `Sample-type`,
stratum = value,
alluvium = Phylum,
y = value,
fill = Phylum,
label = Phylum)) +
geom_alluvium(aes(fill = Phylum), decreasing = FALSE) +
geom_flow(decreasing = FALSE) +
geom_stratum(alpha = 0.5, decreasing = FALSE) +
geom_text(stat = "alluvium",
aes(label = Phylum), size= 1.75,
decreasing = FALSE) +
facet_wrap(patient_ID ~ . ) +
scale_fill_manual(values = Palette) +
theme_classic()
plot <- plot + labs(x = "Sample type", y = "Relative abundance (%)",
title = "Relative abundance of Phyla",
subtitle = "filtered data based off of prevalence") +
theme(legend.text = element_text(size=8,
face = "italic"))
plot
ggsave("Paired-samples alluvial Phylum filtered.pdf", width = 800, height=500, units = c("mm"), dpi=400)
setwd(dir = "~/GitHub/Imperial-Molyneaux/IPF-progressive/")
path <- "~/GitHub/Imperial-Molyneaux/IPF-progressive/"
list.files(path)
physeq<-qza_to_phyloseq("filtered-metadata-table.qza",
"merged-midrooted-tree.qza",
"taxonomy-merged-final.qza",
"Manifest-map.txt")
mapping = readxl::read_xlsx("HC-IPF_map.xlsx")
setwd(dir = "~/GitHub/Imperial-Molyneaux/IPF-progressive/")
path <- "~/GitHub/Imperial-Molyneaux/IPF-progressive/"
list.files(path)
physeq<-qza_to_phyloseq("filtered-metadata-table.qza",
"merged-midrooted-tree.qza",
"taxonomy-merged-final.qza",
"Manifest-map.txt")
setwd(dir = "~/GitHub/Imperial-Molyneaux/IPF-progressive/Diagnosis-IPF/")
path <- "~/GitHub/Imperial-Molyneaux/IPF-progressive/Diagnosis-IPF/"
list.files(path)
physeq<-qza_to_phyloseq("filtered-metadata-table.qza",
"merged-midrooted-tree.qza",
"taxonomy-merged-final.qza",
"Manifest-map.txt")
mapping = readxl::read_xlsx("HC-IPF_map.xlsx")
mapping <- dplyr::rename("index" = "#SampleID", mapping)
mapping$Level1 <- gsub("Controls", "Control", mapping$Level1)
mapping <- mapping[!duplicated(mapping$index), ]
mapping <- column_to_rownames(mapping, var = "index")
gplots::venn(list(mapping=rownames(mapping), sample_names(physeq))) # All samples match
sample_data(physeq) <- mapping
physeq
summarize_phyloseq(physeq)
##Alpha-Plot
p = plot_richness(physeq, x="Level1", color="Level1", measures=c("Observed","Shannon", "Chao1"))
print(p)
p + geom_boxplot(data = p$data, aes(x = Level1, y = value, color = NULL), alpha = 0.1) +
scale_colour_manual(values=c("darkorange", "darkblue","steelblue", "orchid")) +
theme_classic()+ theme(axis.text.x=element_blank(),axis.text.y=element_blank(),axis.ticks=element_blank())
#Temporary fix to colour bug is to add a "dummy variable" in sample_data:
sample_data(physeq)[ , 2] <- sample_data(physeq)[ ,1]
p = plot_ordination(physeq, ordu, color="Level1") + geom_point(size = 3) +
ggtitle("PCoA on weighted-UniFrac distance") + (scale_colour_brewer(type="qual", palette="Set1"))
